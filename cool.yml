version: 0.2

phases:
  install:
    commands:
      - npm install
  runtime-versions:
      nodejs: 18 
  pre_build:
    commands:
      - npm run lint
  build:
    commands:
      - npm run test -- --coverage
  post_build:
    commands:
      - |
        COVERAGE=$(npx jest --coverage --silent --json --outputFile=coverage/coverage-summary.json && cat coverage/coverage-summary.json | jq .total.lines.pct)
        if (( $(echo "$COVERAGE < 80" | bc -l) )); then
          echo "Code coverage is below 80%"
          exit 1
        fi
        echo "Code coverage is $COVERAGE%"

reports:
  coverage:
    files:
      - coverage/coverage-summary.json
    file-format: JACOCOJSON
    base-directory: coverage
